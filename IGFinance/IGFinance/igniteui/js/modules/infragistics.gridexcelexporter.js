/*!@license
 * Infragistics.Web.ClientUI Widget 15.1.20151.1005
 *
 * Copyright (c) 2011-2015 Infragistics Inc.
 *
 * http://www.infragistics.com/
 *
 * 
 * Depends on:
 *  jquery-1.4.4.js
 *  jquery.ui.core.js
 *  jquery.ui.widget.js
 *  FileSaver.js
 *  infragistics.ui.grid.framework.js
 *  infragistics.ui.grid.columnfixing.js
 *  infragistics.ui.grid.filtering.js
 *  infragistics.ui.grid.hiding.js
 *  infragistics.ui.grid.paging.js
 *  infragistics.ui.grid.sorting.js
 *  infragistics.ui.grid.summaries.js
 *  infragistics.excel.js
 */
if(typeof jQuery!=="function"){throw new Error("jQuery is undefined")}(function($){$.ig=$.ig||{};$.ig.GridExcelExporter=$.ig.GridExcelExporter||Class.extend({settings:{fileName:"igGrid",gridFeatureOptions:{sorting:"none",paging:"allRows",hiding:"none",filtering:"none",columnfixing:"none",summaries:"none"},worksheetName:"Sheet1",columnsToSkip:[],tableStyle:"TableStyleMedium1",gridStyling:"applied"},callbacks:{exportStarting:null,cellExporting:null,cellExported:null,headerCellExporting:null,headerCellExported:null,rowExporting:null,rowExported:null,summaryExporting:null,summaryExported:null,exportEnding:null,success:null,error:null},init:function(){this.settings=$.extend({},this.settings);this.callbacks=$.extend({},this.callbacks)},"export":function(grid,userSettings,userCallbacks){this._setGridReferences(grid);this._setSettings(userSettings);this._setCallbacks(userCallbacks);if(!this._handleEventCallback(this.callbacks.exportStarting,{grid:this._gridWidget})){return}var self=this;setTimeout(function(){self._createExcelWorkbookWithWorksheet();if(self._columnsToExport.length>0){self._getGridStyles();self._exportHeaders();self._createExcelTableRegion();self._exportDataSegment();if(self._shouldResizeTableRegion){self._resizeTableRegion()}self._exportFeatures();self._calculateColumnsSize()}var noCancel=self._handleEventCallback(self.callbacks.exportEnding,{grid:self._gridWidget,workbook:self._workbook,worksheet:self._worksheet});if(!noCancel){return}self._saveWorkbook()},0)},_setGridReferences:function(grid){this._grid=grid.data("igGrid");this._gridData=this._grid.dataSource.data();this._gridWidget=grid;this._dataRows=this._gridWidget.igGrid("rows")},_setSettings:function(userSettings){this._enableFeaturesAsInGrid();this._setUserSettings(userSettings);this._setColumnsToExport(this.settings.columnsToSkip)},_enableFeaturesAsInGrid:function(){for(var gridFeatureOption in this.settings.gridFeatureOptions){if(!this._getFeature(gridFeatureOption)){continue}if(gridFeatureOption==="paging"){this.settings.gridFeatureOptions[gridFeatureOption]="allRows"}else{this.settings.gridFeatureOptions[gridFeatureOption]="applied"}}},_setUserSettings:function(userSettings){this.settings=$.extend(this.settings,userSettings)},_setColumnsToExport:function(){var gridColumns=this._grid.options.columns,columnsToSkip=this.settings.columnsToSkip;this._columnsToExport=[];for(var i=0;i<gridColumns.length;i++){var gridColumn=gridColumns[i];if(gridColumn.hidden&&this.settings.gridFeatureOptions.hiding==="visibleColumnsOnly"){continue}if(columnsToSkip.indexOf(gridColumn.key)<0){this._columnsToExport.push(gridColumn)}}},_setCallbacks:function(userCallbacks){this.callbacks=$.extend(this.callbacks,userCallbacks)},_createExcelWorkbookWithWorksheet:function(){this._xlRowIndex=0;this._workbook=new $.ig.excel.Workbook($.ig.excel.WorkbookFormat.excel2007);this._worksheet=this._workbook.worksheets().add(this.settings.worksheetName)},_getGridStyles:function(){if(this.settings.gridStyling==="applied"){var $stylesTR=$("<tr>").attr({"class":"ui-ig-altrecord ui-iggrid-altrecord"}).appendTo(this._gridWidget.igGrid("headersTable")).css("display","none");var $th=$(this._gridWidget.igGrid("headersTable").find("th")[0]).clone().css("display","none");$stylesTR.append($th);this._headersBackColor=$th.removeClass("ui-state-active").css("background-color");$th.remove();this._headersForeColor=this._gridWidget.igGrid("headersTable").find(".ui-iggrid-headertext").css("color");if($stylesTR.css("background-color").indexOf("rgba")>-1){var backTopColor=$stylesTR.css("background-color").replace("rgba(","").replace(")","").split(", ");var backBotColor=this._gridWidget.css("background-color").replace("rgb(","").replace(")","").split(", ");this._altRowColor=this._RGBAtoRGB(backTopColor[0],backTopColor[1],backTopColor[2],backTopColor[3],backBotColor[0],backBotColor[1],backBotColor[2])}else{this._altRowColor=$stylesTR.css("background-color")}this._notAltRowColor=this._gridWidget.css("background-color");this._rowForeColor=this._gridWidget.css("color");$stylesTR.remove()}},_RGBAtoRGB:function(r,g,b,a,r2,g2,b2){var r3=a*r+(1-a)*r2;var g3=a*g+(1-a)*g2;var b3=a*b+(1-a)*b2;return"rgb("+r3+","+g3+","+b3+")"},_createExcelTableRegion:function(){var regionRowsLength,paging=this.settings.gridFeatureOptions.paging,filtering=this.settings.gridFeatureOptions.filtering,counter=0;if(paging==="currentPage"&&this._getFeature("Paging")){regionRowsLength=this._grid.dataSource.dataView().length}else if(paging==="allRows"){regionRowsLength=this._gridData.length}else if(filtering==="filteredRowsOnly"){var filteredData=this._grid.dataSource._filteredData;if(filteredData===undefined||filteredData.length===0){regionRowsLength=this._gridData.length}else{regionRowsLength=this._grid.dataSource._filteredData.length}}else{regionRowsLength=this._gridData.length}for(var i=0;i<this._columnsToExport.length;i++){if(this._columnsToExport[i].hidden){counter++}}this._worksheetRegion=new $.ig.excel.WorksheetRegion(this._worksheet,0,0,regionRowsLength,this._columnsToExport.length-1);this._worksheetTable=this._worksheetRegion.formatAsTable(true);this._worksheetTable.style(this._workbook.standardTableStyles(this.settings.tableStyle));this._woorksheetTableColumns=this._worksheetTable.columns()},_exportHeaders:function(){var xlRow=this._worksheet.rows(this._xlRowIndex),headerFill=$.ig.excel.CellFill.createSolidFill(this._headersBackColor);xlRow.cellFormat().font().bold(1);for(var columnIndex=0;columnIndex<this._columnsToExport.length;columnIndex++){var args={headerText:this._columnsToExport[columnIndex].headerText,columnKey:this._columnsToExport[columnIndex].key,columnIndex:columnIndex,xlRow:xlRow},noCancel=this._handleEventCallback(this.callbacks.headerCellExporting,args);if(!noCancel){return}if(this.settings.gridStyling==="applied"){xlRow.getCellFormat(columnIndex).fill(headerFill);xlRow.getCellFormat(columnIndex).font().colorInfo(new $.ig.excel.WorkbookColorInfo(this._headersForeColor))}this._exportCell(xlRow,columnIndex,args.headerText);this._handleEventCallback(this.callbacks.headerCellExported,args)}this._xlRowIndex++;this._worksheet.displayOptions().frozenPaneSettings().frozenRows(this._xlRowIndex);this._worksheet.displayOptions().panesAreFrozen(true)},_exportDataSegment:function(){var xlRow,dataRow,dataToExport,paging=this.settings.gridFeatureOptions.paging,filtering=this.settings.gridFeatureOptions.filtering;if(paging==="currentPage"&&this._getFeature("Paging")){dataToExport=this._grid.dataSource.dataView()}else if(paging==="allRows"&&filtering==="none"){dataToExport=this._gridData}else if(filtering==="filteredRowsOnly"){var filteredData=this._grid.dataSource._filteredData;if(filteredData===undefined){dataToExport=this._gridData}else{dataToExport=this._grid.dataSource._filteredData}if(filteredData.length===0){this._recalculateTableEnd();this._shouldResizeTableRegion=true}}else{dataToExport=this._gridData}var wasRowExportingCancelled=false;for(var rowIndex=0;rowIndex<dataToExport.length;rowIndex++){xlRow=this._worksheet.rows(this._xlRowIndex);dataRow=dataToExport[rowIndex];var row={element:this._dataRows[rowIndex],index:rowIndex,id:this._getGridRowId(dataRow,rowIndex)};var args={row:row,xlRow:xlRow,grid:this._gridWidget},noCancel=this._handleEventCallback(this.callbacks.rowExporting,args);if(!noCancel){wasRowExportingCancelled=true;continue}this._exportDataSegmentRow(xlRow,dataRow,rowIndex);this._handleEventCallback(this.callbacks.rowExported,args);this._xlRowIndex++}if(wasRowExportingCancelled){this._recalculateTableEnd();this._shouldResizeTableRegion=true}},_exportDataSegmentRow:function(xlRow,dataRow,rowIndex){var gridColumn,dataCell,cellFill;if(xlRow.index()%2===0){cellFill=$.ig.excel.CellFill.createSolidFill(this._altRowColor)}else{cellFill=$.ig.excel.CellFill.createSolidFill(this._notAltRowColor)}for(var columnIndex=0;columnIndex<this._columnsToExport.length;columnIndex++){gridColumn=this._columnsToExport[columnIndex];dataCell=dataRow[gridColumn.key];if(this.settings.gridStyling==="applied"){xlRow.getCellFormat(columnIndex).fill(cellFill);xlRow.getCellFormat(columnIndex).font().colorInfo(new $.ig.excel.WorkbookColorInfo(this._rowForeColor))}if(gridColumn.dataType==="bool"){this._exportCell(xlRow,columnIndex,dataCell.toString())}else if(typeof dataCell==="object"||gridColumn.formatter!==undefined||gridColumn.unbound){dataCell=this._gridWidget.igGrid("getCellText",this._getGridRowId(dataRow,rowIndex),gridColumn.key);this._exportCell(xlRow,columnIndex,dataCell)}else{this._exportCell(xlRow,columnIndex,dataCell)}}},_exportCell:function(xlRow,columnIndex,cellValue){var args={columnKey:this._columnsToExport[columnIndex].key,columnIndex:columnIndex,xlRow:xlRow,cellValue:cellValue},noCancel=this._handleEventCallback(this.callbacks.cellExporting,args);if(!noCancel){return}xlRow.setCellValue(columnIndex,args.cellValue);this._handleEventCallback(this.callbacks.cellExported,args)},_getGridRowId:function(dataRow,rowIndex){var rowId;if(this._grid.options.primaryKey!==null){rowId=dataRow[this._grid.options.primaryKey]}else{rowId=rowIndex}return rowId},_recalculateTableEnd:function(){var cols=this._worksheetTable.columns().count()-1;var xlRowIndex=this._xlRowIndex-1;this._tableRegionEndCellReference=$.ig.excel.WorksheetCell.getCellAddressString(this._worksheet.rows().item(xlRowIndex),cols,$.ig.excel.CellReferenceMode.a1,false).toString()},_resizeTableRegion:function(){var tableRegionStartCellReference=$.ig.excel.WorksheetCell.getCellAddressString(this._worksheet.rows().item(0),0,$.ig.excel.CellReferenceMode.a1,false).toString();if(tableRegionStartCellReference.substring(tableRegionStartCellReference.lastIndexOf("$")+1)===this._tableRegionEndCellReference.substring(this._tableRegionEndCellReference.lastIndexOf("$")+1)){var nextRowIndex=parseInt(this._tableRegionEndCellReference.substring(this._tableRegionEndCellReference.lastIndexOf("$")+1))+1;this._tableRegionEndCellReference=this._tableRegionEndCellReference.substring(0,this._tableRegionEndCellReference.lastIndexOf("$")+1)+nextRowIndex.toString()}this._worksheetTable.resize(tableRegionStartCellReference+":"+this._tableRegionEndCellReference)},_exportFeatures:function(){var features=this.settings.gridFeatureOptions;var featureName;for(var i=0;i<this._grid.options.features.length;i++){featureName=this._grid.options.features[i].name;if(features[featureName.toLowerCase()]===undefined){continue}if(featureName!=="Paging"&&featureName!=="Hiding"){if(features[featureName.toLowerCase()]!=="none"){this["_export"+featureName]()}}}},_getFeature:function(name){var features=this._grid.options.features;for(var featureIndex=0;featureIndex<features.length;featureIndex++){var feature=features[featureIndex];if(feature.name.toLowerCase()===name.toLowerCase()){return feature}}return null},_exportSorting:function(){var orderedSortConditions=this._createSortingConditions();var sortExpressions=this._grid.dataSource.settings.sorting.expressions;var columnToSort,sortDirection;for(var i=0;i<sortExpressions.length;i++){for(var j=0;j<this._columnsToExport.length;j++){if(sortExpressions[i].fieldName===this._columnsToExport[j].key){columnToSort=this._worksheetTable.columns().item(j);sortDirection=sortExpressions[i].dir;if(columnToSort!==undefined&&sortDirection!==undefined){this._worksheetTable.sortSettings().sortConditions().add(columnToSort,orderedSortConditions[sortDirection])}}}}},_createSortingConditions:function(){var orderedSortConditions={asc:new $.ig.excel.OrderedSortCondition($.ig.excel.SortDirection.ascending),desc:new $.ig.excel.OrderedSortCondition($.ig.excel.SortDirection.descending)};return orderedSortConditions},_exportFiltering:function(){if(this.settings.gridFeatureOptions.filtering==="filteredRowsOnly"){return}var filteringConditions=this._createFilteringConditions();var filtExpressions=this._grid.dataSource.settings.filtering.expressions;var columnToFilter,filtCond,filtExpr;if(filtExpressions.length>0){for(var i=0;i<filtExpressions.length;i++){for(var j=0;j<this._columnsToExport.length;j++){if(this._columnsToExport[j].key===filtExpressions[i].fieldName){columnToFilter=this._worksheetTable.columns().item(j);filtCond=filtExpressions[i].cond;filtExpr=filtExpressions[i].expr;switch(filtExpr.getType().name){case"String":columnToFilter.applyCustomFilter(new $.ig.excel.CustomFilterCondition(filteringConditions[filtCond],filtExpr));break;case"Number":columnToFilter.applyCustomFilter(new $.ig.excel.CustomFilterCondition(filteringConditions[filtCond],filtExpr));break;case"Date":break;case"Object":break}}}}}},_createFilteringConditions:function(){var filteringConditions={equals:$.ig.excel.ExcelComparisonOperator.equals,doesNotEqual:$.ig.excel.ExcelComparisonOperator.notEqual,greaterThan:$.ig.excel.ExcelComparisonOperator.greaterThan,greaterThanOrEqualTo:$.ig.excel.ExcelComparisonOperator.greaterThanOrEqual,lessThan:$.ig.excel.ExcelComparisonOperator.lessThan,lessThanOrEqualTo:$.ig.excel.ExcelComparisonOperator.lessThanOrEqual,startsWith:$.ig.excel.ExcelComparisonOperator.beginsWith,endsWith:$.ig.excel.ExcelComparisonOperator.endsWith,contains:$.ig.excel.ExcelComparisonOperator.contains,doesNotContain:$.ig.excel.ExcelComparisonOperator.doesNotContain,"false":$.ig.excel.ExcelComparisonOperator.contains,"true":$.ig.excel.ExcelComparisonOperator.contains};return filteringConditions},_exportSummaries:function(){if(this._xlRowIndex===1){return}var argumentSeparator=1.2.toLocaleString().charAt(1)===","?";":",";var dataEndRowIndex=this._xlRowIndex-1;var summaries=this._gridWidget.igGridSummaries("summaryCollection");var worksheet=this._worksheet;for(var i=0;i<this._columnsToExport.length;i++){var columnIndex=i;var column=this._columnsToExport[columnIndex];if(summaries[column.key]===undefined){continue}var summariesForColumn=summaries[column.key];var dataStartRowIndex=1;var columnReference=new $.ig.excel.WorksheetRegion(this._worksheet,dataStartRowIndex,columnIndex,dataEndRowIndex,columnIndex).toString($.ig.excel.CellReferenceMode.a1,false,true,true);for(var summaryIndex=0;summaryIndex<summariesForColumn.length;summaryIndex++){var summary=summariesForColumn[summaryIndex],summaryType,formatString;switch(summary.type){case"avg":summaryType=101;formatString='"Avg = "0.00';break;case"min":summaryType=105;formatString='"Min = "0.00';break;case"max":summaryType=104;formatString='"Max = "0.00';break;case"count":summaryType=103;formatString='"Count = "0.00';break;case"sum":summaryType=109;formatString='"Sum = "0.00';break}var args={headerText:this._grid.options.columns[columnIndex].headerText,columnKey:this._grid.options.columns[columnIndex].key,columnIndex:columnIndex,summary:summariesForColumn[summaryIndex],xlRowIndex:this._xlRowIndex},noCancel=this._handleEventCallback(this.callbacks.summaryExporting,args);if(!noCancel){return}if(summaryType){var xlRow=worksheet.rows(this._xlRowIndex+summaryIndex);try{xlRow.applyCellFormula(columnIndex,"=SUBTOTAL("+summaryType+argumentSeparator+columnReference+")");xlRow.getCellFormat(columnIndex).formatString(formatString);this._handleEventCallback(this.callbacks.summaryExported,args)}catch(e){console.log(e)}}}}},_exportColumnFixing:function(){var numberOfFrozenCols=0;for(var i=0;i<this._columnsToExport.length;i++){if(this._columnsToExport[i].fixed){numberOfFrozenCols++}}this._worksheet.displayOptions().frozenPaneSettings().frozenColumns(numberOfFrozenCols)},_calculateColumnsSize:function(){var gridFeatureOptions=this.settings.gridFeatureOptions,headers=this._gridWidget.igGrid("headersTable").find("thead"),i,col,colWidth;for(i=0;i<this._columnsToExport.length;i++){var column=this._columnsToExport[i];if(this._getFeature("Hiding")&&gridFeatureOptions.hiding==="none"||column.fixed&&!column.hidden){col=this._worksheet.columns().item(i);colWidth=column.width;if(colWidth&&!column.hidden){if(!isNaN(colWidth)){col.setWidth(colWidth,$.ig.excel.WorksheetColumnWidthUnit.pixel)}else if(isNaN(colWidth)){var widthSize=colWidth.match(/\d+/)[0];if(colWidth.contains("px")){col.setWidth(widthSize,$.ig.excel.WorksheetColumnWidthUnit.pixel)}else{col.setWidth(widthSize/100*this._gridWidget.width(),$.ig.excel.WorksheetColumnWidthUnit.pixel)}}}}else{col=this._worksheet.columns().item(i);colWidth=$(headers).find("#"+this._grid.id()+"_"+column.key).width();col.setWidth(colWidth,$.ig.excel.WorksheetColumnWidthUnit.pixel)}}},_saveWorkbook:function(){var self=this;setTimeout(function(){self._workbook.save({type:"blob"},function(data){saveAs(data,self.settings.fileName+".xlsx");self._handleEventCallback(self.callbacks.success,data)},function(err){self._handleEventCallback(self.callbacks.error,err)})},1)},_handleEventCallback:function(callback,args){if(!$.isFunction(callback)){return true}var noCancel=callback(this,args);if(noCancel===false){return false}return true}});$.ig.GridExcelExporter.export=function(grid,userSettings,userCallbacks){var exp=new $.ig.GridExcelExporter;exp.export(grid,userSettings,userCallbacks);exp=null}})(jQuery);